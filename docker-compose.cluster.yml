services:
  redis-node-1:
    image: redis:alpine
    volumes:
      - ./cluster/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - "7001:6379"
    networks:
      - demo-network

  redis-node-2:
    image: redis:alpine
    volumes:
      - ./cluster/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - "7002:6379"
    networks:
      - demo-network

  redis-node-3:
    image: redis:alpine
    volumes:
      - ./cluster/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - "7003:6379"
    networks:
      - demo-network

  redis-node-4:
    image: redis:alpine
    volumes:
      - ./cluster/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - "7004:6379"
    networks:
      - demo-network

  redis-node-5:
    image: redis:alpine
    volumes:
      - ./cluster/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - "7005:6379"
    networks:
      - demo-network

  redis-node-6:
    image: redis:alpine
    volumes:
      - ./cluster/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - "7006:6379"
    networks:
      - demo-network

  # Cluster Creator
  # This container connects to the nodes and creates the cluster.
  cluster-creator:
    image: redis:alpine
    command: sh -c "sleep 5 && redis-cli --cluster create redis-node-1:6379 redis-node-2:6379 redis-node-3:6379 redis-node-4:6379 redis-node-5:6379 redis-node-6:6379 --cluster-replicas 1 --cluster-yes && echo 'Cluster created' && sleep infinity"
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
      - redis-node-4
      - redis-node-5
      - redis-node-6
    networks:
      - demo-network

  # Application Services
  counting-service:
    build: ./counting-service
    ports:
      - "9001:9001"
    environment:
      - PORT=9001
      - REDIS_MODE=cluster
      - REDIS_CLUSTER_ADDRS=redis-node-1:6379,redis-node-2:6379,redis-node-3:6379,redis-node-4:6379,redis-node-5:6379,redis-node-6:6379
    depends_on:
      - cluster-creator
    networks:
      - demo-network

  dashboard-service:
    build: ./dashboard-service
    ports:
      - "8080:80"
    environment:
      - PORT=80
      - COUNTING_SERVICE_URL=http://counting-service:9001
    depends_on:
      - counting-service
    networks:
      - demo-network

networks:
  demo-network:
    driver: bridge
